<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LUME - لوحة تحكم الطلبات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#3a3a3a',
                        'brand-primary': '#c5a880',
                        'brand-secondary': '#a1887f',
                        'brand-light': '#f5f5f5',
                        'brand-accent': '#e0e0e0',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAbwtVkRJcVIjy7Zf1K6EWgXueBZXJaSXo",
          authDomain: "lumestore-52903.firebaseapp.com",
          projectId: "lumestore-52903",
          storageBucket: "lumestore-52903.firebasestorage.app",
          messagingSenderId: "959648083875",
          appId: "1:959648083875:web:26938a68fab05c76d63416",
          measurementId: "G-2XQ6ZJ0CQN"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>

    <!-- Your entire React application -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONSTANTS ---
        const STATUS_STYLES = {
            'جديد': 'bg-blue-100 text-blue-800',
            'قيد التجهيز': 'bg-orange-100 text-orange-800',
            'تم الشحن': 'bg-green-100 text-green-800',
        };

        const NEXT_STATUS = {
            'جديد': 'قيد التجهيز',
            'قيد التجهيز': 'تم الشحن',
        };

        const NEXT_ACTION_TEXT = {
            'جديد': 'بدء التجهيز',
            'قيد التجهيز': 'تم الشحن',
        };

        const AVAILABLE_SIZES = ['صغيرة', 'وسط', 'كبيرة'];
        const AVAILABLE_SCENTS = ['فانيلا', 'ورد', 'ياسمين', 'ليمون', 'عود', 'بابايا', 'لافندر'];
        const AVAILABLE_PACKAGINGS = ['استخدام شخصي', 'هدية'];
        const CANDLE_NAMES = ['شمعة الأحلام', 'همسة الغروب', 'نسمة الصباح', 'ضوء القمر', 'واحة الهدوء', 'شمعة مخصصة'];

        const getPriceForSize = (size) => {
            switch (size) {
                case 'صغيرة': return 2.75;
                case 'وسط': return 5.50;
                case 'كبيرة': return 7.50;
                default: return 5.50;
            }
        };

        // --- ICONS ---
        const CloseIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
        );
        const PlusIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        );
        const TrashIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.036-2.134H8.718c-1.126 0-2.036.954-2.036 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
        );

        // --- COMPONENTS ---
        const Header = () => {
            return (
                <header className="bg-brand-light/90 backdrop-blur-sm sticky top-0 z-40 shadow-sm">
                    <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h1 className="text-3xl font-bold text-brand-dark tracking-wider">LUME</h1>
                            <span className="text-xl text-brand-secondary font-medium">لوحة تحكم الطلبات</span>
                        </div>
                    </div>
                </header>
            );
        };
        
        const OrderList = ({ orders, onSelectOrder, onOpenAddOrderModal }) => {
            return (
                <section className="container mx-auto px-6 py-12">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-bold text-brand-dark">الطلبات الواردة</h2>
                        <button
                            onClick={onOpenAddOrderModal}
                            className="flex items-center gap-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-secondary transition-all shadow hover:shadow-md transform hover:-translate-y-0.5"
                            aria-label="Add new order"
                        >
                            <PlusIcon className="w-5 h-5" />
                            <span>إضافة طلب جديد</span>
                        </button>
                    </div>

                    {orders.length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-lg shadow-sm">
                            <p className="text-gray-500 text-lg">لا توجد طلبات حاليًا.</p>
                            <p className="text-gray-400 mt-2">سيتم عرض الطلبات الجديدة هنا فور وصولها من المتجر.</p>
                        </div>
                    ) : (
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
                            <div className="hidden md:grid grid-cols-5 gap-4 items-center p-4 font-bold text-brand-dark border-b bg-gray-50">
                                <div><p>العميل</p></div>
                                <div><p>التاريخ</p></div>
                                <div className="text-center"><p>الحالة</p></div>
                                <div className="text-left"><p>المجموع</p></div>
                                <div><p>رقم الطلب</p></div>
                            </div>
                            <div className="divide-y divide-gray-200">
                                {orders.map((order) => (
                                     <div
                                        key={order.id}
                                        onClick={() => onSelectOrder(order)}
                                        className="grid grid-cols-2 md:grid-cols-5 gap-4 items-center p-4 hover:bg-brand-light/50 transition-colors cursor-pointer"
                                    >
                                        <div className="md:hidden col-span-2 space-y-2">
                                            <div className="flex justify-between items-center">
                                                <p className="font-bold text-brand-dark">{order.customerName}</p>
                                                <p className="text-lg font-bold text-brand-primary">{order.total.toFixed(2)} د.أ</p>
                                            </div>
                                            <div className="flex justify-between items-center text-sm">
                                                 <p className="font-medium text-gray-500">{new Date(order.date).toLocaleDateString('ar-EG')}</p>
                                                 <span className={`px-3 py-1 text-xs font-semibold rounded-full ${STATUS_STYLES[order.status]}`}>
                                                    {order.status}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="hidden md:block"><p className="font-medium text-gray-800">{order.customerName}</p></div>
                                        <div className="hidden md:block"><p className="font-medium text-gray-700">{new Date(order.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' })}</p></div>
                                        <div className="hidden md:block text-center"><span className={`px-3 py-1 text-sm font-semibold rounded-full ${STATUS_STYLES[order.status]}`}>{order.status}</span></div>
                                        <div className="hidden md:block text-left"><p className="text-lg font-bold text-brand-primary">{order.total.toFixed(2)} د.أ</p></div>
                                        <div className="hidden md:block"><p className="font-mono text-xs text-gray-500">{order.id}</p></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </section>
            );
        };

        const OrderDetailModal = ({ order, onClose, onUpdateStatus }) => {
            if (!order) return null;

            const handleUpdate = () => {
                const newStatus = NEXT_STATUS[order.status];
                if (newStatus) {
                    onUpdateStatus(order.id, newStatus);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full text-right relative transform transition-all max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className="p-6 border-b border-gray-200">
                            <h2 id="order-details-title" className="text-2xl font-bold text-brand-dark">تفاصيل الطلب</h2>
                             <p className="text-sm text-gray-500 mt-1 font-mono">{order.id}</p>
                            <button onClick={onClose} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600" aria-label="Close modal"><CloseIcon className="w-6 h-6" /></button>
                        </div>

                        <div className="p-6 overflow-y-auto space-y-6">
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div className="bg-gray-50 p-4 rounded-lg"><h3 className="text-sm font-medium text-gray-500 mb-1">الحالة</h3><span className={`px-3 py-1 text-sm font-semibold rounded-full ${STATUS_STYLES[order.status]}`}>{order.status}</span></div>
                                <div className="bg-gray-50 p-4 rounded-lg"><h3 className="text-sm font-medium text-gray-500 mb-1">عدد المنتجات</h3><p className="text-lg font-bold text-brand-dark">{order.items.reduce((sum, item) => sum + item.quantity, 0)}</p></div>
                                <div className="bg-gray-50 p-4 rounded-lg"><h3 className="text-sm font-medium text-gray-500 mb-1">المجموع الكلي</h3><p className="text-lg font-bold text-brand-dark">{order.total.toFixed(2)} د.أ</p></div>
                            </div>
                            <div>
                                <h3 className="text-xl font-semibold text-brand-dark mb-3">معلومات العميل</h3>
                                <div className="bg-gray-50 p-4 rounded-lg grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><h4 className="text-sm font-medium text-gray-500">الاسم</h4><p className="text-md font-semibold text-brand-dark">{order.customerName}</p></div>
                                    <div><h4 className="text-sm font-medium text-gray-500">رقم الهاتف</h4><p className="text-md font-semibold text-brand-dark" dir="ltr">{order.customerPhone || 'لم يحدد'}</p></div>
                                </div>
                            </div>
                            <div>
                                <h3 className="text-xl font-semibold text-brand-dark mb-3">المنتجات</h3>
                                <div className="space-y-3">
                                    {order.items.map(item => (
                                        <div key={item.id} className="flex items-start space-x-4 space-x-reverse bg-white p-3 rounded-lg border">
                                            <div className="w-16 h-16 rounded-md flex-shrink-0" style={{ backgroundColor: item.color }}></div>
                                            <div className="flex-grow">
                                                <h4 className="font-semibold text-brand-dark">{item.name} <span className="text-sm font-normal text-gray-500">x{item.quantity}</span></h4>
                                                <p className="text-sm text-gray-500">{item.size} / {item.packaging}</p>
                                                <p className="text-sm text-gray-500 truncate" title={item.scents.join(', ')}>{item.scents.join(', ')}</p>
                                            </div>
                                            <p className="text-md font-bold text-brand-primary flex-shrink-0">{(item.price * item.quantity).toFixed(2)} د.أ</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {NEXT_ACTION_TEXT[order.status] && (
                            <div className="p-6 border-t border-gray-200 bg-gray-50 text-left">
                                <button onClick={handleUpdate} className="bg-brand-primary text-white font-bold py-3 px-8 rounded-lg text-md hover:bg-brand-secondary transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">{NEXT_ACTION_TEXT[order.status]}</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AddOrderModal = ({ isOpen, onClose, onAddOrder }) => {
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [items, setItems] = useState([]);
            const [total, setTotal] = useState(0);

            useEffect(() => { if (isOpen) { setCustomerName(''); setCustomerPhone(''); setItems([]); } }, [isOpen]);
            useEffect(() => { setTotal(items.reduce((sum, item) => sum + item.price * item.quantity, 0)); }, [items]);

            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
                const currentItem = { ...newItems[index], [field]: value };
                if (field === 'size') { currentItem.price = getPriceForSize(value); }
                newItems[index] = currentItem;
                setItems(newItems);
            };

            const handleAddItem = () => {
                setItems([...items, { name: 'شمعة مخصصة', size: 'وسط', scents: ['فانيلا'], color: '#FFFFFF', packaging: 'استخدام شخصي', price: getPriceForSize('وسط'), quantity: 1 }]);
            };
            
            const handleRemoveItem = (index) => { setItems(items.filter((_, i) => i !== index)); };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!customerName || items.length === 0) { alert('يرجى إدخال اسم العميل ومنتج واحد على الأقل.'); return; }
                const newOrder = { date: new Date().toISOString(), customerName, customerPhone, items: items.map((item, index) => ({ ...item, id: `${Date.now()}-${index}` })), total, status: 'جديد' };
                onAddOrder(newOrder);
            };
            
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full text-right relative max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className="p-6 border-b border-gray-200"><h2 className="text-2xl font-bold text-brand-dark">إضافة طلب جديد</h2><button onClick={onClose} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600" aria-label="Close modal"><CloseIcon className="w-6 h-6" /></button></div>
                        <form onSubmit={handleSubmit} className="flex flex-col flex-grow">
                            <div className="p-6 overflow-y-auto space-y-6">
                                <fieldset className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <legend className="text-xl font-semibold text-brand-dark mb-3 col-span-full">معلومات العميل</legend>
                                    <div><label htmlFor="customerName" className="block text-sm font-medium text-gray-700 mb-1">اسم العميل</label><input type="text" id="customerName" value={customerName} onChange={(e) => setCustomerName(e.target.value)} className="w-full border-gray-300 rounded-md shadow-sm" required /></div>
                                    <div><label htmlFor="customerPhone" className="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف (اختياري)</label><input type="tel" id="customerPhone" value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className="w-full border-gray-300 rounded-md shadow-sm" /></div>
                                </fieldset>
                                <fieldset>
                                    <legend className="text-xl font-semibold text-brand-dark mb-3">المنتجات</legend>
                                    <div className="space-y-4">
                                        {items.map((item, index) => (
                                            <div key={index} className="bg-gray-50 p-4 rounded-lg border space-y-3">
                                                <div className="flex justify-between items-center"><h4 className="font-semibold text-brand-dark">المنتج #{index + 1}</h4><button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-700" aria-label="Remove item"><TrashIcon className="w-5 h-5" /></button></div>
                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                    <div className="col-span-2 md:col-span-1"><label className="text-xs text-gray-600">الاسم</label><select value={item.name} onChange={(e) => handleItemChange(index, 'name', e.target.value)} className="w-full border-gray-300 rounded-md shadow-sm text-sm">{CANDLE_NAMES.map(name => <option key={name} value={name}>{name}</option>)}</select></div>
                                                    <div><label className="text-xs text-gray-600">الحجم</label><select value={item.size} onChange={(e) => handleItemChange(index, 'size', e.target.value)} className="w-full border-gray-300 rounded-md shadow-sm text-sm">{AVAILABLE_SIZES.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                                    <div><label className="text-xs text-gray-600">التغليف</label><select value={item.packaging} onChange={(e) => handleItemChange(index, 'packaging', e.target.value)} className="w-full border-gray-300 rounded-md shadow-sm text-sm">{AVAILABLE_PACKAGINGS.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                                                    <div><label className="text-xs text-gray-600">الكمية</label><input type="number" min="1" value={item.quantity} onChange={(e) => handleItemChange(index, 'quantity', parseInt(e.target.value))} className="w-full border-gray-300 rounded-md shadow-sm text-sm" /></div>
                                                    <div><label className="text-xs text-gray-600">اللون</label><input type="color" value={item.color} onChange={(e) => handleItemChange(index, 'color', e.target.value)} className="w-full h-10 border-gray-300 rounded-md shadow-sm" /></div>
                                                    <div><label className="text-xs text-gray-600">السعر</label><p className="font-bold text-brand-primary mt-2">{(item.price * item.quantity).toFixed(2)} د.أ</p></div>
                                                </div>
                                            </div>
                                        ))}
                                        <button type="button" onClick={handleAddItem} className="flex items-center gap-2 text-sm font-medium text-brand-primary hover:text-brand-secondary"><PlusIcon className="w-4 h-4" /><span>إضافة منتج آخر</span></button>
                                    </div>
                                </fieldset>
                            </div>
                            <div className="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                                <div><span className="text-lg font-bold text-brand-dark">المجموع الكلي: </span><span className="text-xl font-bold text-brand-primary">{total.toFixed(2)} د.أ</span></div>
                                <button type="submit" className="bg-brand-primary text-white font-bold py-3 px-8 rounded-lg text-md hover:bg-brand-secondary transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">حفظ الطلب</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        // --- MAIN APP ---
        function App() {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [isAddOrderModalOpen, setAddOrderModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!firebase.apps.length || !firebase.firestore) {
                    console.error("Firebase is not initialized.");
                    setIsLoading(false);
                    return;
                }
                const db = firebase.firestore();
                const unsubscribe = db.collection("LUME_ORDERS")
                    .orderBy("date", "desc")
                    .onSnapshot(snapshot => {
                        const fetchedOrders = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setOrders(fetchedOrders);
                        setIsLoading(false);
                    }, error => {
                        console.error("Error fetching orders: ", error);
                        setIsLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            const handleAddOrder = (newOrderData) => {
                const db = firebase.firestore();
                db.collection("LUME_ORDERS").add(newOrderData)
                    .then(() => {
                        setAddOrderModalOpen(false);
                    })
                    .catch(error => console.error("Error adding order: ", error));
            };

            const handleUpdateOrderStatus = (orderId, newStatus) => {
                const db = firebase.firestore();
                db.collection("LUME_ORDERS").doc(orderId).update({ status: newStatus })
                    .then(() => {
                        setSelectedOrder(prev => prev && prev.id === orderId ? { ...prev, status: newStatus } : prev);
                    })
                    .catch(error => console.error("Error updating status: ", error));
            };

            return (
                <div className="bg-brand-light min-h-screen text-gray-800">
                    <Header />
                    <main>
                        {isLoading ? (
                            <div className="text-center py-20 text-gray-500">جاري تحميل الطلبات...</div>
                        ) : (
                            <OrderList
                                orders={orders}
                                onSelectOrder={setSelectedOrder}
                                onOpenAddOrderModal={() => setAddOrderModalOpen(true)}
                            />
                        )}
                    </main>
                    <OrderDetailModal
                        order={selectedOrder}
                        onClose={() => setSelectedOrder(null)}
                        onUpdateStatus={handleUpdateOrderStatus}
                    />
                    <AddOrderModal
                        isOpen={isAddOrderModalOpen}
                        onClose={() => setAddOrderModalOpen(false)}
                        onAddOrder={handleAddOrder}
                    />
                </div>
            );
        }

        // --- Final Rendering Call ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
